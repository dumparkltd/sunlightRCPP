.rs.restartR()
.rs.restartR()
base::copy('a')
library(sunlightRCPP)
# dem="pyrenees_30.tif"
# # dem="pyrenees_30_EPSG32631.tif
# demDir = "~/projects/INRAE/data/30m/"
# outDir = "~/projects/INRAE/data/30m/altitudes/"
#
# demFileAndPath = paste(demDir, dem, sep="")
# print(paste(Sys.time(), " - ", "loading dem: ", dem, " from: ", demFileAndPath, sep=""))
# dem_original = raster::raster(demFileAndPath)
#
#
# precalcAltitudes(
#   dem=dem,
#   demDir = demDir,
#   outDir = outDir,
#   azimuthStep = 1,
#   azimuthMin = 60,
#   azimuthMax = 60,
#   targetResolution = 30,
#   sampleIncFactor = 1.03,
# )
#
# altitudeDir = "~/projects/INRAE/data/30m/altitudes/"
# outDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
# altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05.tif"
# azimuthMin = 122
# azimuthMax = 304
# azimuthStep = 2
# stripeNo = 40
#
# cutMinAltitudes(
#     altitudeDir = altitudeDir,
#     altitudeFilePattern = altitudeFilePattern,
#     altitudeFilePlaceholder = 'azi',
#     outDir = outDir,
#     azimuthMin = azimuthMin,
#     azimuthMax = azimuthMax,
#     azimuthStep = azimuthStep,
#     stripeNo = stripeNo
# )
timeStartUTC = '2022-12-22 0:00:00'
timeStopUTC = '2022-12-22 23:59:00'
timestep = 15 # minutes
outDir = "~/projects/INRAE/data/30m/durations/"
altitudesDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
sunlightDurationForTimeAndStripes (
timeStartUTC = timeStartUTC,
timeStopUTC = timeStopUTC,
timestep = timestep,
altitudesDir = altitudesDir,
altitudeFilePattern = altitudeFilePattern,
altitudeFilePlaceholder = 'azi',
altitudeFilePlaceholderStripe = 'stripe',
outDir = outDir,
azimuthStep = 2,
azimuthMin = 56,
stripeNo = 2
)
library(sunlightRCPP)
library(sunlightRCPP)
library(sunlightRCPP)
# dem="pyrenees_30.tif"
# # dem="pyrenees_30_EPSG32631.tif
# demDir = "~/projects/INRAE/data/30m/"
# outDir = "~/projects/INRAE/data/30m/altitudes/"
#
# demFileAndPath = paste(demDir, dem, sep="")
# print(paste(Sys.time(), " - ", "loading dem: ", dem, " from: ", demFileAndPath, sep=""))
# dem_original = raster::raster(demFileAndPath)
#
#
# precalcAltitudes(
#   dem=dem,
#   demDir = demDir,
#   outDir = outDir,
#   azimuthStep = 1,
#   azimuthMin = 60,
#   azimuthMax = 60,
#   targetResolution = 30,
#   sampleIncFactor = 1.03,
# )
#
# altitudeDir = "~/projects/INRAE/data/30m/altitudes/"
# outDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
# altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05.tif"
# azimuthMin = 122
# azimuthMax = 304
# azimuthStep = 2
# stripeNo = 40
#
# cutMinAltitudes(
#     altitudeDir = altitudeDir,
#     altitudeFilePattern = altitudeFilePattern,
#     altitudeFilePlaceholder = 'azi',
#     outDir = outDir,
#     azimuthMin = azimuthMin,
#     azimuthMax = azimuthMax,
#     azimuthStep = azimuthStep,
#     stripeNo = stripeNo
# )
timeStartUTC = '2022-12-22 0:00:00'
timeStopUTC = '2022-12-22 23:59:00'
timestep = 15 # minutes
outDir = "~/projects/INRAE/data/30m/durations/"
altitudesDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
sunlightDurationForTimeAndStripes (
timeStartUTC = timeStartUTC,
timeStopUTC = timeStopUTC,
timestep = timestep,
altitudesDir = altitudesDir,
altitudeFilePattern = altitudeFilePattern,
altitudeFilePlaceholder = 'azi',
altitudeFilePlaceholderStripe = 'stripe',
outDir = outDir,
azimuthStep = 2,
azimuthMin = 56,
stripeNo = 2
)
.rs.restartR()
.rs.restartR()
.rs.restartR()
library(sunlightRCPP)
library(sunlightRCPP)
# dem="pyrenees_30.tif"
# # dem="pyrenees_30_EPSG32631.tif
# demDir = "~/projects/INRAE/data/30m/"
# outDir = "~/projects/INRAE/data/30m/altitudes/"
#
# demFileAndPath = paste(demDir, dem, sep="")
# print(paste(Sys.time(), " - ", "loading dem: ", dem, " from: ", demFileAndPath, sep=""))
# dem_original = raster::raster(demFileAndPath)
#
#
# precalcAltitudes(
#   dem=dem,
#   demDir = demDir,
#   outDir = outDir,
#   azimuthStep = 1,
#   azimuthMin = 60,
#   azimuthMax = 60,
#   targetResolution = 30,
#   sampleIncFactor = 1.03,
# )
#
# altitudeDir = "~/projects/INRAE/data/30m/altitudes/"
# outDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
# altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05.tif"
# azimuthMin = 122
# azimuthMax = 304
# azimuthStep = 2
# stripeNo = 40
#
# cutMinAltitudes(
#     altitudeDir = altitudeDir,
#     altitudeFilePattern = altitudeFilePattern,
#     altitudeFilePlaceholder = 'azi',
#     outDir = outDir,
#     azimuthMin = azimuthMin,
#     azimuthMax = azimuthMax,
#     azimuthStep = azimuthStep,
#     stripeNo = stripeNo
# )
timeStartUTC = '2022-12-22 0:00:00'
timeStopUTC = '2022-12-22 23:59:00'
timestep = 15 # minutes
outDir = "~/projects/INRAE/data/30m/durations/"
altitudesDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05_stripe-{stripe}.tif"
sunlightDurationForTimeAndStripes (
timeStartUTC = timeStartUTC,
timeStopUTC = timeStopUTC,
timestep = timestep,
altitudesDir = altitudesDir,
altitudeFilePattern = altitudeFilePattern,
altitudeFilePlaceholder = 'azi',
altitudeFilePlaceholderStripe = 'stripe',
outDir = outDir,
azimuthStep = 2,
azimuthMin = 56,
stripeNo = 2
)
.rs.restartR()
.rs.restartR()
.rs.restartR()
.rs.restartR()
library(sunlightRCPP)
sunlightDurationForTimeAndStripes (
timeStartUTC = timeStartUTC,
timeStopUTC = timeStopUTC,
timestep = timestep,
altitudesDir = altitudesDir,
altitudeFilePattern = altitudeFilePattern,
altitudeFilePlaceholder = 'azi',
altitudeFilePlaceholderStripe = 'stripe',
outDir = outDir,
azimuthStep = 2,
azimuthMin = 56,
stripeNo = 40
)
.rs.restartR()
.rs.restartR()
.rs.restartR()
library(sunlightRCPP)
library(sunlightRCPP)
# dem="pyrenees_30.tif"
# # dem="pyrenees_30_EPSG32631.tif
# demDir = "~/projects/INRAE/data/30m/"
# outDir = "~/projects/INRAE/data/30m/altitudes/"
#
# demFileAndPath = paste(demDir, dem, sep="")
# print(paste(Sys.time(), " - ", "loading dem: ", dem, " from: ", demFileAndPath, sep=""))
# dem_original = raster::raster(demFileAndPath)
#
#
# precalcAltitudes(
#   dem=dem,
#   demDir = demDir,
#   outDir = outDir,
#   azimuthStep = 1,
#   azimuthMin = 60,
#   azimuthMax = 60,
#   targetResolution = 30,
#   sampleIncFactor = 1.03,
# )
#
# altitudeDir = "~/projects/INRAE/data/30m/altitudes/"
# outDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
# altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05.tif"
# azimuthMin = 122
# azimuthMax = 304
# azimuthStep = 2
# stripeNo = 40
#
# cutMinAltitudes(
#     altitudeDir = altitudeDir,
#     altitudeFilePattern = altitudeFilePattern,
#     altitudeFilePlaceholder = 'azi',
#     outDir = outDir,
#     azimuthMin = azimuthMin,
#     azimuthMax = azimuthMax,
#     azimuthStep = azimuthStep,
#     stripeNo = stripeNo
# )
timeStartUTC = '2022-06-21 0:00:00'
timeStopUTC = '2022-06-21 23:59:00'
timestep = 15 # minutes
outDir = "~/projects/INRAE/data/30m/durations/"
altitudesDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05_stripe-{stripe}.tif"
sunlightDurationForTimeAndStripes (
timeStartUTC = timeStartUTC,
timeStopUTC = timeStopUTC,
timestep = timestep,
altitudesDir = altitudesDir,
altitudeFilePattern = altitudeFilePattern,
altitudeFilePlaceholder = 'azi',
altitudeFilePlaceholderStripe = 'stripe',
outDir = outDir,
azimuthStep = 2,
azimuthMin = 56,
stripeNo = 40
)
library(sunlightRCPP)
# dem="pyrenees_30.tif"
# # dem="pyrenees_30_EPSG32631.tif
# demDir = "~/projects/INRAE/data/30m/"
# outDir = "~/projects/INRAE/data/30m/altitudes/"
#
# demFileAndPath = paste(demDir, dem, sep="")
# print(paste(Sys.time(), " - ", "loading dem: ", dem, " from: ", demFileAndPath, sep=""))
# dem_original = raster::raster(demFileAndPath)
#
#
# precalcAltitudes(
#   dem=dem,
#   demDir = demDir,
#   outDir = outDir,
#   azimuthStep = 1,
#   azimuthMin = 60,
#   azimuthMax = 60,
#   targetResolution = 30,
#   sampleIncFactor = 1.03,
# )
#
# altitudeDir = "~/projects/INRAE/data/30m/altitudes/"
# outDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
# altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05.tif"
# azimuthMin = 122
# azimuthMax = 304
# azimuthStep = 2
# stripeNo = 40
#
# cutMinAltitudes(
#     altitudeDir = altitudeDir,
#     altitudeFilePattern = altitudeFilePattern,
#     altitudeFilePlaceholder = 'azi',
#     outDir = outDir,
#     azimuthMin = azimuthMin,
#     azimuthMax = azimuthMax,
#     azimuthStep = azimuthStep,
#     stripeNo = stripeNo
# )
timeStartUTC = '2022-03-21 0:00:00'
timeStopUTC = '2022-03-21 23:59:00'
timestep = 15 # minutes
outDir = "~/projects/INRAE/data/30m/durations/"
altitudesDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05_stripe-{stripe}.tif"
sunlightDurationForTimeAndStripes (
timeStartUTC = timeStartUTC,
timeStopUTC = timeStopUTC,
timestep = timestep,
altitudesDir = altitudesDir,
altitudeFilePattern = altitudeFilePattern,
altitudeFilePlaceholder = 'azi',
altitudeFilePlaceholderStripe = 'stripe',
outDir = outDir,
azimuthStep = 2,
azimuthMin = 56,
stripeNo = 40
)
library(sunlightRCPP)
# dem="pyrenees_30.tif"
# # dem="pyrenees_30_EPSG32631.tif
# demDir = "~/projects/INRAE/data/30m/"
# outDir = "~/projects/INRAE/data/30m/altitudes/"
#
# demFileAndPath = paste(demDir, dem, sep="")
# print(paste(Sys.time(), " - ", "loading dem: ", dem, " from: ", demFileAndPath, sep=""))
# dem_original = raster::raster(demFileAndPath)
#
#
# precalcAltitudes(
#   dem=dem,
#   demDir = demDir,
#   outDir = outDir,
#   azimuthStep = 1,
#   azimuthMin = 60,
#   azimuthMax = 60,
#   targetResolution = 30,
#   sampleIncFactor = 1.03,
# )
#
# altitudeDir = "~/projects/INRAE/data/30m/altitudes/"
# outDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
# altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05.tif"
# azimuthMin = 122
# azimuthMax = 304
# azimuthStep = 2
# stripeNo = 40
#
# cutMinAltitudes(
#     altitudeDir = altitudeDir,
#     altitudeFilePattern = altitudeFilePattern,
#     altitudeFilePlaceholder = 'azi',
#     outDir = outDir,
#     azimuthMin = azimuthMin,
#     azimuthMax = azimuthMax,
#     azimuthStep = azimuthStep,
#     stripeNo = stripeNo
# )
timeStartUTC = '2022-09-23 0:00:00'
timeStopUTC = '2022-09-23 23:59:00'
timestep = 15 # minutes
outDir = "~/projects/INRAE/data/30m/durations/"
altitudesDir = "~/projects/INRAE/data/30m/altitudes/stripes/"
altitudeFilePattern = "altitudes_azimuth-{azi}_res-30_inc-1-05_stripe-{stripe}.tif"
sunlightDurationForTimeAndStripes (
timeStartUTC = timeStartUTC,
timeStopUTC = timeStopUTC,
timestep = timestep,
altitudesDir = altitudesDir,
altitudeFilePattern = altitudeFilePattern,
altitudeFilePlaceholder = 'azi',
altitudeFilePlaceholderStripe = 'stripe',
outDir = outDir,
azimuthStep = 2,
azimuthMin = 56,
stripeNo = 40
)
precalcAltitudes = function(
dem = "pyrenees_5m_final.tif",
demDir = "~/projects/INRAE/data/5m/",
outDir = "~/projects/INRAE/data/5m/out/",
azimuthStep = 1,
azimuthMin = 270,
azimuthMax = 270,
gridConvergence = 0, # WGS84
correctCurvature = FALSE,
sampleIncFactor = 1,
cutVertically = FALSE,
stripeWidth = 10000,
originalResolution = 5,
)
precalcAltitudes = function(
dem = "pyrenees_5m_final.tif",
demDir = "~/projects/INRAE/data/5m/",
outDir = "~/projects/INRAE/data/5m/out/",
azimuthStep = 1,
azimuthMin = 270,
azimuthMax = 270,
gridConvergence = 0, # WGS84
correctCurvature = FALSE,
sampleIncFactor = 1,
cutVertically = FALSE,
stripeWidth = 10000,
originalResolution = 5
)
#'
#'@param dem dem raster
#'@param azimuth_min lower bounds of azimuths to calculate
#'@param azimuth_max upper bounds of azimuths
#'@param settings a settings object
#'@import raster
#'@return list of min altitudes for range of azimuths
#'@export
#'
#'
calculateMinAltitudes = function(dem_raster, azimuth_min, azimuth_max, settings) {
for (azimuth in seq(azimuth_min, azimuth_max, by = settings$azimuth_step)) {
print(paste(Sys.time(), ' - ', 'calculating altitudes for azimuth: ', azimuth, sep=""))
outFilename = paste(
settings$out_dir,
"altitudes_azimuth-", azimuth,
"_res-", gsub("\\.", "-", as.character(settings$resolution_dem)),
"_inc-", gsub("\\.", "-", as.character(settings$inc_factor)),
".tif",
sep=""
)
# call CPP function get_altitudes_for_azimuth_cpp to calculate the minimum
# altitudes for all cells in the dem and current azimuth
# returns a NumericMatrix
alt_azi = get_altitudes_for_azimuth_cpp(
as.matrix(dem_raster),
azimuth,
settings$grid_convergence,
settings$resolution_dem,
settings$correct_curvature,
settings$inc_factor
)
print(paste(Sys.time(), ' - ', 'writing raster for azimuth ', azimuth, ' to: ', outFilename, sep=""))
rasterForAzimuth <- raster::raster(
nrows = raster::nrow(dem_raster),
ncols = raster::ncol(dem_raster),
ext = raster::extent(dem_raster),
res = raster::res(dem_raster),
crs = raster::crs(dem_raster),
vals = alt_azi
)
raster::writeRaster(
rasterForAzimuth,
filename=outFilename,
format="GTiff",
overwrite=TRUE
)
print(paste(Sys.time(), ' - ', 'DONE: writing raster for azimuth: ', azimuth, sep=""))
if (settings$cut_vertically == TRUE) {
print(paste(Sys.time(), ' - ', 'writing raster stripes for azimuth: ', azimuth, sep=""))
xres = raster::xres(rasterForAzimuth) # in px
stripe_w_px = stripeWidth/xres # in p
num_stripes <- ceiling(ncol(rasterForAzimuth) / stripe_w_px)
stripe_boundaries <- seq(from = 1, to = ncol(rasterForAzimuth), by = stripe_w_px)
stripe_boundaries <- c(stripe_boundaries, ncol(rasterForAzimuth))
stripes <- list()
for (i in 1:(num_stripes)) {
start_col <- stripe_boundaries[i]
end_col <- stripe_boundaries[i+1] - 1
stripes[[i]] <- raster::crop(rasterForAzimuth, raster::extent(rasterForAzimuth, 1, raster::nrow(rasterForAzimuth), start_col, end_col))
}
for (i in 1:(num_stripes)) {
stripe <- stripes[[i]]
outFilename = paste(
"altitudes_azimuth-", azimuth,
"_stripe-", i,
".tif",
sep=""
)
# print(outFilename)
# print(result[[azimuth]])
raster::writeRaster(
stripe,
filename=paste(outDir, outFilename, sep=""),
format="GTiff",
overwrite=TRUE
)
}
print(paste(Sys.time(), ' - ', 'DONE: writing raster stripes for azimuth: ', azimuth, sep=""))
}
}
}
devtools::load_all(".")
rm(list = c("precalcAltitudes"))
devtools::load_all(".")
precalcAltitudes(
dem = "pyrenees_5m_final.tif",
demDir = "~/projects/INRAE/data/5m/",
outDir = "~/projects/INRAE/data/5m/out/",
azimuthStep = 1,
azimuthMin = 270,
azimuthMax = 270,
gridConvergence = 0, # WGS84
correctCurvature = FALSE,
sampleIncFactor = 1,
cutVertically = FALSE,
stripeWidth = 10000,
originalResolution = 5,
)
devtools::load_all(".")
sessionInfo()
